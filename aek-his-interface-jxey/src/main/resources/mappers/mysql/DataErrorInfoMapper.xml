<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<!--
操作相关SQL Mapper
@author Lanpz
@date 2016-08-05
@source Generated by MySQL2Java
-->

<!-- 此命名空间必须和对应Mapper.java文件的命名空间一致 -->
<mapper namespace="com.aek.persistence.mysql.mapper.DataErrorInfoMapper">

    <!-- 栏位列表 -->
    <resultMap id="rm" type="com.aek.persistence.oracle.beans.DataErrorInfo">
        <result property="errorId" jdbcType="INTEGER" column="error_id" />
        <result property="errorMsg" jdbcType="VARCHAR" column="error_msg" />
        <result property="happenTime" jdbcType="VARCHAR" column="happen_time" />
        <result property="tableName" jdbcType="VARCHAR" column="table_name" />
        <result property="primaryKey" jdbcType="INTEGER" column="primary_key" />
        <result property="excuteTime" jdbcType="INTEGER" column="excute_time" />
        <result property="isSolved" jdbcType="INTEGER" column="is_solved" />
    </resultMap>

    <select id="getErrorCount" resultType="int">
    <![CDATA[
        SELECT count(*)
          FROM data_error_info
        WHERE excute_time < 3
          AND is_solved = 0
          AND primary_key is not null
    ]]>
    </select>

    <select id="getExcuteList" resultMap="rm" parameterType="map">
    <![CDATA[
        SELECT *
          FROM data_error_info
        WHERE excute_time < 3
          AND is_solved = 0
          AND primary_key is not null
        LIMIT #{begin}, #{end}
    ]]>
    </select>

    <select id="getPrimarykey" resultType="java.lang.Integer" parameterType="java.lang.Integer">
        SELECT excute_time
          FROM data_error_info
        WHERE primary_key = #{primaryKey}
    </select>

    <!-- 获取 -->
    <select id="getErrorList" resultMap="rm">
        SELECT *
          FROM data_error_info
         WHERE is_solved = 0
           AND primary_key is not null
    </select>

    <!-- 添加 -->
    <insert id="insert" parameterType="com.aek.persistence.oracle.beans.DataErrorInfo">
        INSERT INTO data_error_info(error_msg,happen_time,table_name,primary_key,is_solved,excute_time)
        VALUES (#{errorMsg},#{happenTime},#{tableName},#{primaryKey},#{isSolved}, #{excuteTime})
    </insert>

    <!-- 修改 -->
    <update id="update" parameterType="com.aek.persistence.oracle.beans.DataErrorInfo">
        UPDATE data_error_info
           SET error_msg=#{errorMsg},
               happen_time=#{happenTime},
               table_name=#{tableName},
               primary_key=#{primaryKey},
               excute_time=#{excuteTime}
         WHERE error_id = #{errorId}
    </update>

    <!-- 修改处理状态根据存放的错误信息的主键id -->
    <update id="updateByKey" parameterType="java.lang.Integer">
        UPDATE data_error_info
           SET is_solved = 1,
               excute_time = (excute_time + 1)
         WHERE primary_key = #{primaryKey}
    </update>
    
    <!-- 修改处理状态根据存放的错误信息的主键id -->
    <update id="updateError" parameterType="java.lang.Integer">
        UPDATE data_error_info
           SET excute_time = (excute_time + 1)
         WHERE primary_key = #{primaryKey}
    </update>

    <!-- 作废 -->
    <update id="delete" parameterType="java.lang.Integer">
        UPDATE data_error_info
            SET is_solved = 1
         WHERE error_id = #{errorId}
    </update>

</mapper>
