<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<!--
库房出库明细。操作相关SQL Mapper
@author Lanpz
@date 2016-12-20
@source Generated by MySQL2Java
-->

<!-- 此命名空间必须和对应Mapper.java文件的命名空间一致 -->
<mapper namespace="com.aek.persistence.mysql.mapper.MSdHplStockOutItemsMapper">

    <!-- 库房出库明细。栏位列表 -->
    <resultMap id="rm" type="com.aek.persistence.oracle.beans.SdHplStockOutItems">
        <result property="itemId" jdbcType="BIGINT" column="item_id" />
        <result property="areaId" jdbcType="INTEGER" column="area_id" />
        <result property="sysId" jdbcType="BIGINT" column="sys_id" />
        <result property="whId" jdbcType="BIGINT" column="wh_id" />
        <result property="whName" jdbcType="VARCHAR" column="wh_name"/>
        <result property="whSiteId" jdbcType="BIGINT" column="wh_site_id" />
        <result property="whSiteName" jdbcType="VARCHAR" column="wh_site_name"/>
        <result property="formId" jdbcType="BIGINT" column="form_id" />
        <result property="itemIndex" jdbcType="INTEGER" column="item_index" />
        <result property="exchangeId" jdbcType="BIGINT" column="exchange_id" />
        <result property="specId" jdbcType="BIGINT" column="spec_id" />
        <result property="specModel" jdbcType="VARCHAR" column="spec_model"/>
        <result property="goodsName" jdbcType="VARCHAR" column="goods_name" />
        <result property="commonName" jdbcType="VARCHAR" column="common_name" />
        <result property="specSize" jdbcType="VARCHAR" column="spec_size" />
        <result property="regNo" jdbcType="VARCHAR" column="reg_no" />
        <result property="specUnit" jdbcType="VARCHAR" column="spec_unit" />
        <result property="unitPrice" jdbcType="DOUBLE" column="unit_price" />
        <result property="specPackage" jdbcType="VARCHAR" column="spec_package" />
        <result property="splId" jdbcType="BIGINT" column="spl_id" />
        <result property="splName" jdbcType="VARCHAR" column="spl_name"/>
        <result property="facId" jdbcType="BIGINT" column="fac_id" />
        <result property="facName" jdbcType="VARCHAR" column="fac_name"/>
        <result property="factoryAddr" jdbcType="VARCHAR" column="factory_addr" />
        <result property="specBrand" jdbcType="VARCHAR" column="spec_brand" />
        <result property="stockOutQty" jdbcType="INTEGER" column="stock_out_qty" />
        <result property="stockPrice" jdbcType="DOUBLE" column="stock_price" />
        <result property="stockGiftQty" jdbcType="INTEGER" column="stock_gift_qty" />
        <result property="stockReturnQty" jdbcType="INTEGER" column="stock_return_qty" />
        <result property="stockOldQty" jdbcType="INTEGER" column="stock_old_qty" />
        <result property="stockAmount" jdbcType="DOUBLE" column="stock_amount" />
        <result property="specBarcodeType" jdbcType="BIGINT" column="spec_barcode_type" />
        <result property="barcodeId" jdbcType="BIGINT" column="barcode_id" />
        <result property="barcodeStr" jdbcType="VARCHAR" column="barcode_str" />
        <result property="batchNo" jdbcType="VARCHAR" column="batch_no" />
        <result property="productDate" jdbcType="VARCHAR" column="product_date" />
        <result property="expiredDate" jdbcType="VARCHAR" column="expired_date" />
        <result property="sterilizeNo" jdbcType="VARCHAR" column="sterilize_no" />
        <result property="sterilizeDate" jdbcType="VARCHAR" column="sterilize_date" />
        <result property="lockFlag" jdbcType="INTEGER" column="lock_flag" />
        <result property="reqItemId" jdbcType="INTEGER" column="req_item_id" />
        <result property="stockCheckReason" jdbcType="VARCHAR" column="stock_check_reason" />
        <result property="redItemId" jdbcType="BIGINT" column="red_item_id" />
        <result property="addBy" jdbcType="BIGINT" column="add_by" />
        <result property="addName" jdbcType="VARCHAR" column="add_name" />
        <result property="addTime" jdbcType="VARCHAR" column="add_time"/>
        <result property="lastEditBy" jdbcType="BIGINT" column="last_edit_by" />
        <result property="lastEditName" jdbcType="VARCHAR" column="last_edit_name" />
        <result property="lastEditTime" jdbcType="VARCHAR" column="last_edit_time" />
        <result property="curId" jdbcType="BIGINT" column="cur_id" />
        <result property="accountType" jdbcType="BIGINT" column="account_type" />
        <result property="calcType" jdbcType="BIGINT" column="calc_type" />
        <result property="accountTypeName" jdbcType="VARCHAR" column="account_type_name" />
        <result property="calcTypeName" jdbcType="VARCHAR" column="calc_type_name" />
        <result property="stockRedQty" jdbcType="INTEGER" column="stock_red_qty" />
        <result property="stockAccQty" jdbcType="INTEGER" column="stock_acc_qty" />
        <result property="stockBudgetQty" jdbcType="INTEGER" column="stock_budget_qty" />
        <result property="stockCancelQty" jdbcType="INTEGER" column="stock_cancel_qty" />
        <result property="stockBackQty" jdbcType="INTEGER" column="stock_back_qty" />
        <result property="accItemId" jdbcType="BIGINT" column="acc_item_id" />
        <result property="budgetItemId" jdbcType="BIGINT" column="budget_item_id" />
        <result property="cancelItemId" jdbcType="BIGINT" column="cancel_item_id" />
        <result property="returnItemId" jdbcType="BIGINT" column="return_item_id" />
        <result property="backItemId" jdbcType="BIGINT" column="back_item_id" />
        <result property="delFlag" jdbcType="INTEGER" column="del_flag"/>
    </resultMap>

<sql id="oitem">
	 oitem.item_id, oitem.area_id, oitem.sys_id, outs.wh_id, oitem.wh_site_id,	oitem.wh_smart_id, 
	 oitem.wh_smartsite_id, oitem.form_id, oitem.item_index, oitem.exchange_id, oitem.spec_id, oitem.goods_name,	
	 IF(oitem.common_name='',NULL, oitem.common_name) common_name, oitem.spec_size, oitem.reg_no, oitem.spec_unit, 
	 oitem.unit_price, oitem.spec_package, oitem.spl_id, oitem.fac_id, oitem.factory_addr, oitem.spec_brand,	
	 oitem.stock_out_qty, oitem.stock_price, oitem.stock_gift_qty, oitem.stock_return_qty, oitem.stock_old_qty, 
	 oitem.stock_amount, oitem.spec_barcode_type, oitem.barcode_id,	oitem.barcode_str, oitem.batch_no, oitem.sterilize_no, 
	 oitem.lock_flag, oitem.req_item_id, oitem.stock_check_reason, oitem.red_item_id, oitem.add_by, oitem.add_name,
     oitem.last_edit_by, oitem.last_edit_name, oitem.del_flag, oitem.cur_id, oitem.account_type, oitem.calc_type,
     oitem.stock_flag, oitem.stock_red_qty, oitem.stock_acc_qty, oitem.stock_budget_qty, oitem.stock_cancel_qty, 
     oitem.stock_back_qty, oitem.acc_item_id, oitem.budget_item_id,	oitem.cancel_item_id, oitem.return_item_id,	oitem.back_item_id
</sql>

<sql id="ritem">
	ritem.item_id, ritem.area_id, ritem.sys_id, outs.wh_id, ritem.wh_site_id, ritem.wh_smart_id, 
	ritem.wh_smartsite_id, ritem.form_id, ritem.item_index, ritem.exchange_id, ritem.spec_id, goods.goods_name,	
	NULL AS common_name, NULL AS spec_size, ritem.reg_no, NULL AS spec_unit, ritem.unit_price, NULL AS spec_package, 
	outs.spl_id, goods.fac_id, fac.fac_addr_detail AS factory_addr, NULL AS spec_brand,	-ritem.stock_rt_qty AS stock_out_qty, 
	ritem.stock_rt_price AS stock_price, 0 AS stock_gift_qty, 0 AS stock_return_qty, ritem.stock_old_qty, 
	-ritem.stock_rt_amount AS stock_amount, spec.spec_barcode_type, ritem.barcode_id,	ritem.barcode_str, ritem.batch_no, 
	ritem.sterilize_no, ritem.lock_flag, NULL AS req_item_id, NULL AS stock_check_reason, NULL AS red_item_id, ritem.add_by, 
	ritem.add_name,ritem.last_edit_by, ritem.last_edit_name, ritem.del_flag, ritem.cur_id, ritem.account_type, ritem.calc_type,
	ritem.stock_flag, -ritem.stock_rt_qty AS stock_red_qty, 0 AS stock_acc_qty, 0 AS stock_budget_qty, 0 AS stock_cancel_qty, 
	0 AS stock_back_qty, NULL AS acc_item_id, NULL AS budget_item_id, NULL AS cancel_item_id, NULL AS return_item_id, NULL AS back_item_id
</sql>


    <!-- 获取库房出库明细。 -->
    <select id="getItemList" resultMap="rm" parameterType="java.util.HashMap">
        (SELECT <include refid="oitem"/>, fac.fac_name, spl.spl_name,spec.spec_model,wh.wh_name, site.wh_site_name,
               date_format(oitem.add_time,'%Y-%m-%d %T') AS add_time,
               date_format(oitem.last_edit_time,'%Y-%m-%d %T') AS last_edit_time,
               date_format(oitem.sterilize_date,'%Y-%m-%d %T') AS sterilize_date,
               date_format(oitem.expired_date,'%Y-%m-%d %T') AS expired_date,
               date_format(oitem.product_date,'%Y-%m-%d %T') AS product_date,
               account.account_name AS account_type_name,
               calc.calc_name AS calc_type_name
			   FROM herp.sd_hpl_stock_out_items oitem 
			   LEFT JOIN herp.sd_hpl_stock_out outs ON outs.form_id = oitem.form_id AND outs.sys_id = oitem.sys_id 
			   LEFT JOIN herp.base_factory_info fac ON oitem.fac_id = fac.fac_id 
			   LEFT JOIN herp.base_suppliers spl ON oitem.spl_id = spl.spl_id
			   LEFT JOIN herp.bd_hpl_goods_specs spec ON oitem.spec_id = spec.spec_id
			   LEFT JOIN herp.pm_hpl_wh_info wh ON outs.wh_id = wh.wh_id
			   LEFT JOIN herp.pm_hpl_wh_site site ON site.wh_site_id = oitem.wh_site_id
			   LEFT JOIN herp.bd_hpl_account_books account ON oitem.account_type=account.account_id
			   LEFT JOIN herp.bd_hpl_calc_types calc ON oitem.calc_type=calc.calc_id
         WHERE oitem.stock_flag = 0 
           AND outs.form_status = 3
        <if test="null != dateFlag and 1 == dateFlag">
           AND IFNULL(date_format(oitem.last_edit_time,'%Y-%m-%d'),date_format(oitem.add_time,'%Y-%m-%d')) &gt;= date_format('2017-02-01','%Y-%m-%d')
        </if>
         LIMIT #{begin}, #{end})
      	 UNION ALL
      	 (SELECT <include refid="ritem"/>, fac.fac_name, spl.spl_name,spec.spec_model,wh.wh_name, site.wh_site_name,
               date_format(ritem.add_time,'%Y-%m-%d %T') AS add_time,
               date_format(ritem.last_edit_time,'%Y-%m-%d %T') AS last_edit_time,
               date_format(ritem.sterilize_date,'%Y-%m-%d %T') AS sterilize_date,
               date_format(ritem.expired_date,'%Y-%m-%d %T') AS expired_date,
               date_format(ritem.product_date,'%Y-%m-%d %T') AS product_date,
               account.account_name AS account_type_name,
               calc.calc_name AS calc_type_name
          FROM herp.sd_hpl_stock_red_items ritem 
	      LEFT JOIN herp.sd_hpl_stock_red outs ON outs.form_id = ritem.form_id AND outs.sys_id = ritem.sys_id 
	      LEFT JOIN herp.base_suppliers spl ON ritem.spl_id = spl.spl_id
	      LEFT JOIN herp.bd_hpl_goods_specs spec ON ritem.spec_id = spec.spec_id
	      LEFT JOIN herp.bd_hpl_goodses goods ON goods.goods_id = spec.goods_id
	      LEFT JOIN herp.base_factory_info fac ON goods.fac_id = fac.fac_id 
	      LEFT JOIN herp.pm_hpl_wh_info wh ON ritem.wh_id = wh.wh_id
	      LEFT JOIN herp.pm_hpl_wh_site site ON site.wh_site_id = ritem.wh_site_id
	      LEFT JOIN herp.bd_hpl_account_books account ON ritem.account_type=account.account_id
	      LEFT JOIN herp.bd_hpl_calc_types calc ON ritem.calc_type=calc.calc_id
          WHERE ritem.stock_flag = 0 AND outs.form_status = 3 AND outs.return_type = 0
          <if test="null != dateFlag and 1 == dateFlag">
            AND IFNULL(date_format(ritem.last_edit_time,'%Y-%m-%d'),date_format(ritem.add_time,'%Y-%m-%d')) &gt;= date_format('2017-01-01','%Y-%m-%d')
          </if>
          LIMIT #{begin}, #{end})
    </select>

</mapper>
