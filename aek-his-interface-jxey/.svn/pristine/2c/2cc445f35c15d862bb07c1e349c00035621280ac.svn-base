<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<!--
库房正常出库记录。操作相关SQL Mapper
@author Lanpz
@date 2016-12-20
@source Generated by MySQL2Java
-->

<!-- 此命名空间必须和对应Mapper.java文件的命名空间一致 -->
<mapper namespace="com.aek.persistence.mysql.mapper.MSdHplStockOutMapper">

    <!-- 库房正常出库记录。栏位列表 -->
    <resultMap id="rm" type="com.aek.persistence.oracle.beans.SdHplStockOut">
       <result property="formId" jdbcType="BIGINT" column="form_id" />
        <result property="formNo" jdbcType="BIGINT" column="form_no" />
        <result property="outType" jdbcType="INTEGER" column="out_type" />
        <result property="stockFlag" jdbcType="INTEGER" column="stock_flag" />
        <result property="areaId" jdbcType="INTEGER" column="area_id" />
        <result property="sysId" jdbcType="BIGINT" column="sys_id" />
        <result property="periodNo" jdbcType="INTEGER" column="period_no" />
        <result property="whOutId" jdbcType="BIGINT" column="wh_out_id" />
        <result property="whOutName" jdbcType="VARCHAR" column="wh_out_name"/>
        <result property="whId" jdbcType="BIGINT" column="wh_id" />
        <result property="whName" jdbcType="VARCHAR" column="wh_name"/>
        <result property="whSiteId" jdbcType="BIGINT" column="wh_site_id" />
        <result property="whSiteName" jdbcType="VARCHAR" column="wh_site_name"/>
        <result property="deptId" jdbcType="BIGINT" column="dept_id" />
        <result property="deptNo" jdbcType="VARCHAR" column="dept_no"/>
        <result property="deptName" jdbcType="VARCHAR" column="dept_name"/>
        <result property="accountType" jdbcType="BIGINT" column="account_type" />
        <result property="accountTypeName" jdbcType="VARCHAR" column="account_type_name"/>
        <result property="calcType" jdbcType="BIGINT" column="calc_type" />
        <result property="calcTypeName" jdbcType="VARCHAR" column="calc_type_name"/>
        <result property="fundsSource" jdbcType="BIGINT" column="funds_source" />
        <result property="fundsSourceName" jdbcType="VARCHAR" column="funds_source_name"/>
        <result property="requestUser" jdbcType="BIGINT" column="request_user" />
        <result property="originalForm" jdbcType="BIGINT" column="original_form" />
        <result property="receiverType" jdbcType="INTEGER" column="receiver_type" />
        <result property="receiverNote" jdbcType="VARCHAR" column="receiver_note" />
        <result property="receiverName" jdbcType="VARCHAR" column="receiver_name" />
        <result property="receiverAddr" jdbcType="VARCHAR" column="receiver_addr" />
        <result property="receiverPhone" jdbcType="VARCHAR" column="receiver_phone" />
        <result property="formQty" jdbcType="INTEGER" column="form_qty" />
        <result property="formAmount" jdbcType="VARCHAR" column="form_amount" />
        <result property="outAmount" jdbcType="VARCHAR" column="out_amount" />
        <result property="formStatus" jdbcType="INTEGER" column="form_status" />
        <result property="formRemark" jdbcType="VARCHAR" column="form_remark" />
        <result property="printTimes" jdbcType="INTEGER" column="print_times" />
        <result property="redTimes" jdbcType="INTEGER" column="red_times" />
        <result property="redFlag" jdbcType="INTEGER" column="red_flag" />
        <result property="redFormId" jdbcType="BIGINT" column="red_form_id" />
        <result property="stockInFormId" jdbcType="BIGINT" column="stock_in_form_id" />
        <result property="submitBy" jdbcType="BIGINT" column="submit_by" />
        <result property="submitName" jdbcType="VARCHAR" column="submit_name" />
        <result property="submitTime" jdbcType="VARCHAR" column="submit_time" />
        <result property="approveBy" jdbcType="BIGINT" column="approve_by" />
        <result property="approveName" jdbcType="VARCHAR" column="approve_name" />
        <result property="approveTime" jdbcType="VARCHAR" column="approve_time" />
        <result property="accountBy" jdbcType="BIGINT" column="account_by" />
        <result property="accountName" jdbcType="VARCHAR" column="account_name" />
        <result property="accountTime" jdbcType="VARCHAR" column="account_time" />
        <result property="addBy" jdbcType="BIGINT" column="add_by" />
        <result property="addName" jdbcType="VARCHAR" column="add_name" />
        <result property="addTime" jdbcType="VARCHAR" column="add_time"/>
        <result property="lastEditBy" jdbcType="BIGINT" column="last_edit_by" />
        <result property="lastEditName" jdbcType="VARCHAR" column="last_edit_name" />
        <result property="lastEditTime" jdbcType="VARCHAR" column="last_edit_time" />
        <result property="deptRoomId" jdbcType="BIGINT" column="dept_room_id" />
        <result property="inpatientNo" jdbcType="VARCHAR" column="inpatient_no" />
        <result property="patientName" jdbcType="VARCHAR" column="patient_name" />
        <result property="bedNo" jdbcType="VARCHAR" column="bed_no" />
        <result property="deptRoomName" jdbcType="VARCHAR" column="dept_room_name" />
        <result property="delFlag" jdbcType="BIT" column="del_flag" />
    </resultMap>

<sql id="out">
	outs.form_id, outs.form_no, outs.out_type, outs.stock_flag, outs.area_id,  
	outs.sys_id, outs.period_no, outs.wh_out_id, outs.wh_id, outs.wh_site_id, 
	outs.wh_smart_id, outs.dept_id, outs.funds_source,outs.request_user,
	outs.original_form, outs.receiver_type, IF(outs.receiver_note='', NULL, outs.receiver_note) receiver_note, 
	outs.receiver_name, outs.receiver_addr, outs.receiver_phone, outs.form_qty,	
	outs.form_amount, outs.out_amount, outs.form_status, IF(outs.form_remark='', NULL, outs.form_remark) form_remark, 
	outs.print_times, outs.red_times, outs.red_flag, outs.red_form_id, 
	outs.stock_in_form_id, outs.submit_by, outs.submit_name, outs.approve_by, 
	outs.approve_name, outs.account_by,outs.account_name, outs.add_by, 
	outs.add_name, outs.last_edit_by, outs.last_edit_name, outs.del_flag, 
	outs.dept_room_id, outs.inpatient_no, outs.patient_name, outs.bed_no, outs.dept_room_name
</sql>

<sql id="red">
	red.form_id, red.form_no, red.return_fun AS out_type, red.stock_flag, red.area_id,  
	red.sys_id, red.period_no, red.wh_id AS wh_out_id, NULL AS wh_id, red.wh_site_id, 
	red.wh_smart_id, red.dept_id, red.funds_source, NULL AS request_user, 
    red.stock_rt_id AS original_form, NULL AS receiver_type, NULL AS receiver_note, NULL AS receiver_name, 
	NULL AS receiver_addr, NULL AS receiver_phone, -red.form_qty,	
	-red.form_amount, NULL AS out_amount, red.form_status, IF(red.form_remark='', NULL, red.form_remark) form_remark, 
	red.print_times, red.red_times, red.red_flag, NULL AS red_form_id, 
	NULL AS stock_in_form_id, red.submit_by, red.submit_name, red.approve_by, 
	red.approve_name, red.account_by,red.account_name, red.add_by, 
	red.add_name, red.last_edit_by, red.last_edit_name, red.del_flag, NULL AS dept_room_id,  
	NULL AS inpatient_no, NULL AS patient_name, NULL AS bed_no, NULL AS dept_room_name
</sql>
	
	<!--  获取库房正常出库记录。 -->
    <select id="getOutList" resultMap="rm" parameterType="java.util.Map">
        (SELECT <include refid="out"/>, dept.his_dept_no AS dept_no,
               dept.dept_name,
               wh.wh_name,
               whout.wh_name AS wh_out_name,
               site.wh_site_name,
               date_format(outs.add_time, '%Y-%m-%d %T') AS add_time,
               date_format(outs.last_edit_time, '%Y-%m-%d %T') AS last_edit_time,
               date_format(outs.submit_time, '%Y-%m-%d %T') AS submit_time,
               date_format(outs.approve_time, '%Y-%m-%d %T') AS approve_time,
               date_format(outs.account_time, '%Y-%m-%d %T') AS account_time, 
               account.account_name AS account_type_name,
               calc.calc_name AS calc_type_name,
               funds.code_text AS funds_source_name,
               outitems.account_type, outitems.calc_type, sum(outitems.stock_amount) as form_amount
          FROM herp.sd_hpl_stock_out outs
          LEFT JOIN herp.sd_hpl_stock_out_items outitems on outs.form_id = outitems.form_id 
          LEFT JOIN herp.pm_hpl_dept_info dept ON outs.dept_id = dept.dept_id
          LEFT JOIN herp.pm_hpl_wh_info wh ON wh.wh_id = outs.wh_id
          LEFT JOIN herp.pm_hpl_wh_info whout ON whout.wh_id = outs.wh_out_id
          LEFT JOIN herp.pm_hpl_wh_site site ON outs.wh_site_id = site.wh_site_id
          LEFT JOIN herp.bd_hpl_account_books account ON outitems.account_type=account.account_id
          LEFT JOIN herp.bd_hpl_calc_types calc ON outitems.calc_type=calc.calc_id
          LEFT JOIN herp.bd_hpl_code_info funds ON outs.funds_source=funds.code_id
         WHERE outitems.stock_flag=0 AND outs.form_status = 3
         <if test="null != dateFlag and 1 == dateFlag">
           AND IFNULL(date_format(outs.last_edit_time,'%Y-%m-%d'),date_format(outs.add_time,'%Y-%m-%d')) &gt;= date_format('2017-01-01','%Y-%m-%d') 
         </if>
         GROUP BY outitems.form_id
         LIMIT #{begin}, #{end})
         UNION ALL
         (SELECT <include refid="red"/>, dept.his_dept_no AS dept_no,
               dept.dept_name,
			   NULL AS wh_name,
			   wh.wh_name AS wh_out_name,
               site.wh_site_name,
               date_format(red.add_time, '%Y-%m-%d %T') AS add_time,
               date_format(red.last_edit_time, '%Y-%m-%d %T') AS last_edit_time,
               date_format(red.submit_time, '%Y-%m-%d %T') AS submit_time,
               date_format(red.approve_time, '%Y-%m-%d %T') AS approve_time,
               date_format(red.account_time, '%Y-%m-%d %T') AS account_time, 
               account.account_name AS account_type_name,
               calc.calc_name AS calc_type_name,
               funds.code_text AS funds_source_name,
               outitems.account_type, outitems.calc_type, sum(-outitems.stock_rt_amount) as form_amount
          FROM herp.sd_hpl_stock_red red
          LEFT JOIN herp.sd_hpl_stock_red_items outitems on red.form_id = outitems.form_id 
          LEFT JOIN herp.pm_hpl_dept_info dept ON red.dept_id = dept.dept_id
          LEFT JOIN herp.pm_hpl_wh_info wh ON wh.wh_id = red.wh_id
          LEFT JOIN herp.pm_hpl_wh_site site ON red.wh_site_id = site.wh_site_id
          LEFT JOIN herp.bd_hpl_account_books account ON outitems.account_type=account.account_id
          LEFT JOIN herp.bd_hpl_calc_types calc ON outitems.calc_type=calc.calc_id
          LEFT JOIN herp.bd_hpl_code_info funds ON red.funds_source=funds.code_id
         WHERE outitems.stock_flag=0 AND red.form_status = 3 AND red.return_type = 0
         <if test="null != dateFlag and 1 == dateFlag">
           AND IFNULL(date_format(red.last_edit_time,'%Y-%m-%d'),date_format(red.add_time,'%Y-%m-%d')) &gt;= date_format('2017-01-01','%Y-%m-%d') 
         </if> 
         GROUP BY outitems.form_id
         LIMIT #{begin}, #{end})
    </select> 
	
	
	
	
	
   <!--   获取库房正常出库记录。
    <select id="getOutList" resultMap="rm" parameterType="java.util.Map">
        SELECT outs.*, dept.his_dept_no AS dept_no,
               dept.dept_name,
               wh.wh_name,
               whout.wh_name AS wh_out_name,
               site.wh_site_name,
               date_format(outs.add_time, '%Y-%m-%d %T') AS add_time_format,
               date_format(outs.last_edit_time, '%Y-%m-%d %T') AS last_edit_time_format,
               date_format(outs.submit_time, '%Y-%m-%d %T') AS submit_time_format,
               date_format(outs.approve_time, '%Y-%m-%d %T') AS approve_time_format,
               date_format(outs.account_time, '%Y-%m-%d %T') AS account_time_format, 
               account.account_name AS account_type_str,
               calc.calc_name AS calc_type_str,
               funds.code_text AS funds_source_str,sum(outitems.stock_amount) as totalAmount
          FROM herp.sd_hpl_stock_out outs
          RIGHT JOIN herp.sd_hpl_stock_out_items outitems on outs.form_id = outitems.form_id 
          LEFT JOIN herp.pm_hpl_dept_info dept ON outs.dept_id = dept.dept_id
          LEFT JOIN herp.pm_hpl_wh_info wh ON wh.wh_id = outs.wh_id
          LEFT JOIN herp.pm_hpl_wh_info whout ON whout.wh_id = outs.wh_out_id
          LEFT JOIN herp.pm_hpl_wh_site site ON outs.wh_site_id = site.wh_site_id
          LEFT JOIN herp.bd_hpl_account_books account ON outitems.account_type=account.account_id
          LEFT JOIN herp.bd_hpl_calc_types calc ON outitems.calc_type=calc.calc_id
          LEFT JOIN herp.bd_hpl_code_info funds ON outs.funds_source=funds.code_id
         WHERE outitems.stock_flag=0 AND outs.form_status = 3
         <if test="null != dateFlag and 1 == dateFlag">
           AND ifnull(date_format(outs.last_edit_time,'%Y-%m-%d'),date_format(outs.add_time,'%Y-%m-%d')) &gt;= date_format('2017-01-01','%Y-%m-%d') 
         </if>
         GROUP BY outitems.form_id
         LIMIT #{begin}, #{end}
    </select> -->

</mapper>
